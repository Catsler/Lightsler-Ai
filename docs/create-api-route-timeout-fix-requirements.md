# createApiRoute 超时保护修复需求

## 背景
- Phase 1、Phase 2 的 API 重构统一采用 `createApiRoute` 路由包装器，现已覆盖 35+ API 端点。
- 近期定位到当认证、参数解析或校验阶段抛出异常时，包装器在清理超时定时器时触发 `ReferenceError: timeoutId is not defined`，导致所有依赖路由失败。
- 本轮需求旨在以最小变更恢复稳定性，同时补齐该场景的自动化测试，巩固基础设施。

## 根因概述
- `timeoutId` 变量在业务执行的 `try` 代码块内部声明，但在 `catch` 中执行清理逻辑时仍访问该变量。
- 当异常发生在 `timeoutId` 赋值之前（例如认证失败、参数校验异常），`catch` 代码块便会访问未声明的变量并抛出新的错误。
- 错误会掩盖原始业务异常，造成全量路由崩溃及返回 500 响应。

## 目标
1. 修复 `createApiRoute` 的超时清理逻辑，确保任何异常路径都不会产生引用错误。
2. 在现有自动化测试中补充“超时前抛错”的回归用例，并纳入常规测试流程。
3. 保持路由包装器的 KISS 原则：不引入额外抽象或破坏既有上下文契约。

## 功能与设计要求
- 维持现有处理流程：认证 → 参数解析 → 校验 → 业务执行 → 响应封装。
- `timeoutId` 应在 `try/catch` 外部声明，且在 `finally` 中集中清理，防止重复代码与遗漏。
- 保持 `RouteContext` 契约不变（`params` 与 `searchParams` 双通道继续存在），以确保所有调用方无感知。
- `Request timeout` 异常的抛出语义保持不变，原先依赖该错误信息的告警与测试无需调整。

## 测试要求
- 基于 `tests/api/create-api-route.test.js` 新增“业务处理函数在 timeout 设置前抛错”的用例，断言包装器返回 500 且未抛出 `ReferenceError`。
- 测试中需验证 `Promise.race` 超时分支仍能被正确清理，避免意外定时器泄漏。
- 将新增测试纳入默认测试脚本（`npm run test` 或对应的 Vitest 配置），避免仅依赖手动命令。
- 运行 `npm run lint` 与现有 API 回归脚本，确认无额外静态检查或集成用例破坏。

## 验收标准
- QA 或开发者能够复现原始异常场景，并在修复后确认响应恢复到原始业务错误/成功结果。
- 自动化测试覆盖新场景，并于本地与 CI 均默认执行。
- `createApiRoute` 文件中的超时清理逻辑移至 `finally`，Review 表明无多余抽象引入、无接口改动。

## 风险与缓解
- **风险**：修改超时逻辑可能影响现有请求超时的行为。  
  **缓解**：保留原有错误信息与超时时长，变更仅限变量作用域和清理位置。
- **风险**：新增测试可能依赖实验性标志。  
  **缓解**：在脚本中明确使用 Node 官方参数或切换到受支持的测试替身，确保 CI 稳定。

## 发布与回滚策略
- 发布前需在开发环境调用至少一个示例路由（如 `/api/translate`）验证失败路径与成功路径。
- 若线上出现异常，可通过回滚到修复前版本临时恢复；不涉及持久化数据变更。
- 修复合并后需更新监控面板，观察 24 小时内是否仍有 `ReferenceError` 相关日志。

## 交付物清单
- `app/utils/base-route.server.js` 中的超时变量与清理逻辑调整。
- 新增或更新的自动化测试用例及测试脚本。
- 代码审查记录，确认遵循 KISS 原则与现有架构约束。
