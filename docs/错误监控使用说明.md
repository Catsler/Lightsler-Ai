# 错误监控系统使用说明

## 概述
本项目内置了完整的错误监控和日志系统，用于追踪应用运行过程中的各种错误和翻译操作日志。

## 一、错误监控方式

### 1. Web界面监控中心（推荐）

#### 访问地址
```
https://你的域名/app/errors
```

#### 功能特点
- **实时监控面板**：显示今日错误、严重错误、解决率、独特错误等关键指标
- **错误列表**：详细展示所有错误信息，支持分页浏览
- **统计分析**：错误类型分布、严重程度分布等统计图表
- **趋势图表**：错误趋势分析，发现错误高发时段
- **错误报告**：生成综合错误报告，可导出下载
- **自动刷新**：每30秒自动刷新数据

#### 筛选功能
- **状态筛选**：新建、已确认、调查中、已解决、已忽略
- **类型筛选**：API、数据库、验证、网络、翻译、Shopify
- **级别筛选**：低、中、高、严重、致命（1-5级）
- **时间范围**：最近1小时、24小时、7天、30天、所有时间

#### 批量操作
- 选中多个错误后可批量：确认、解决、忽略

#### 错误详情
点击"查看"按钮可查看错误的详细信息：
- 基本信息（消息、代码、指纹、发生次数等）
- 建议修复方案
- 错误堆栈追踪
- 相关错误列表

### 2. API接口监控

#### 翻译日志API
```bash
# 获取翻译日志（最多100条）
GET /api/translation-logs?count=20

# 返回数据包含：
# - stats: 翻译统计信息
# - logs: 详细日志列表
# - timestamp: 时间戳
```

#### 错误管理API
```bash
# 获取错误列表
GET /api/errors?action=list&page=1&pageSize=20

# 获取错误统计
GET /api/errors?action=stats&timeRange=24h

# 获取错误趋势
GET /api/errors?action=trends&timeRange=7d

# 生成错误报告
GET /api/errors?action=report&timeRange=30d&includeDetails=true

# 获取特定错误详情
GET /api/errors?action=detail&id=错误ID

# 获取相关错误
GET /api/errors?action=related&id=错误ID
```

#### 参数说明
- `action`: 操作类型（list/stats/trends/report/detail/related）
- `page`: 页码
- `pageSize`: 每页大小
- `timeRange`: 时间范围（1h/24h/7d/30d/all）
- `status`: 错误状态
- `errorType`: 错误类型
- `severity`: 严重级别（1-5）

### 3. 控制台日志

#### 日志级别
- **ERROR**: 错误日志（红色）
- **WARN**: 警告日志（黄色）
- **INFO**: 信息日志（白色）
- **DEBUG**: 调试日志（灰色）

#### 日志格式
```
[时间戳] [级别] [分类] 消息 {附加数据}
```

#### 查看实时日志
```bash
# 开发环境
npm run dev

# 生产环境（使用PM2）
pm2 logs app-name

# 查看特定时间段的日志
pm2 logs app-name --lines 1000
```

#### 日志分类
- **TRANSLATION**: 翻译相关日志
- **API**: API调用日志
- **VALIDATION**: 验证相关日志
- **PERFORMANCE**: 性能相关日志

### 4. 数据库查询

#### 使用Prisma Studio
```bash
# 启动数据库可视化界面
npx prisma studio

# 访问地址（默认）
http://localhost:5555
```

#### 数据表说明
- **ErrorLog表**：存储所有错误日志
  - `id`: 错误唯一标识
  - `fingerprint`: 错误指纹（用于分组相同错误）
  - `errorType`: 错误类型
  - `errorCode`: 错误代码
  - `message`: 错误消息
  - `stackTrace`: 堆栈追踪
  - `severity`: 严重级别（1-5）
  - `status`: 处理状态
  - `occurrences`: 发生次数
  - `firstSeenAt`: 首次出现时间
  - `lastSeenAt`: 最后出现时间
  - `resolvedAt`: 解决时间
  - `suggestedFix`: 建议修复方案

## 二、错误类型说明

### API错误
- Shopify API调用失败
- 翻译API调用失败
- 认证失败

### 数据库错误
- 查询失败
- 事务失败
- 连接超时

### 验证错误
- 数据格式错误
- 参数缺失
- 类型不匹配

### 网络错误
- 连接失败
- 超时
- DNS解析失败

### 翻译错误
- 翻译失败
- 内容过长
- 语言不支持

### Shopify错误
- GraphQL查询失败
- 权限不足
- 资源不存在

## 三、错误严重级别

| 级别 | 描述 | 处理优先级 | 示例 |
|------|------|-----------|------|
| 1-低 | 不影响功能 | 低 | 日志记录失败 |
| 2-中 | 部分功能受影响 | 中 | 单个翻译失败 |
| 3-高 | 重要功能受影响 | 高 | 批量翻译失败 |
| 4-严重 | 核心功能失败 | 紧急 | 数据库连接失败 |
| 5-致命 | 系统崩溃 | 立即 | 应用启动失败 |

## 四、常用排查命令

### 查看最近错误
```bash
# 查看最近100条错误日志
curl http://localhost:3000/api/errors?action=list&pageSize=100

# 查看今天的错误统计
curl http://localhost:3000/api/errors?action=stats&timeRange=24h
```

### 搜索特定错误
```bash
# 搜索翻译相关错误
curl "http://localhost:3000/api/errors?action=list&errorType=TRANSLATION"

# 搜索严重错误
curl "http://localhost:3000/api/errors?action=list&severity=4"
```

### 导出错误报告
```bash
# 导出最近30天的错误报告
curl "http://localhost:3000/api/errors?action=report&timeRange=30d&includeDetails=true" > error-report.json
```

## 五、错误处理流程

### 1. 错误捕获
所有服务层函数都使用 `withErrorHandling` 包装器自动捕获错误：
```javascript
import { withErrorHandling } from "../utils/error-handler.server.js";

export const action = withErrorHandling(async ({ request }) => {
  // 业务逻辑
});
```

### 2. 错误记录
错误会自动记录到：
- 控制台日志
- ErrorLog数据表
- 错误收集服务

### 3. 错误分析
系统会自动：
- 生成错误指纹（相同错误分组）
- 统计发生频率
- 分析错误趋势
- 提供修复建议

### 4. 错误通知
当出现严重错误时：
- 在Web界面显示警告
- 记录到错误日志
- 可配置邮件通知（需额外配置）

## 六、最佳实践

### 开发阶段
1. 开启DEBUG级别日志查看详细信息
2. 使用 `/app/errors` 页面实时监控
3. 定期清理已解决的错误

### 生产环境
1. 只记录INFO级别以上日志
2. 设置错误告警阈值
3. 定期生成错误报告分析
4. 及时处理严重错误

### 错误修复优先级
1. **立即修复**：级别4-5的错误
2. **当日修复**：级别3的错误
3. **计划修复**：级别1-2的错误
4. **忽略**：已知的第三方服务临时问题

## 七、故障排查步骤

### 1. 确认错误类型
访问 `/app/errors` 查看错误类型和频率

### 2. 查看错误详情
点击具体错误查看：
- 错误消息
- 堆栈追踪
- 发生时间
- 影响范围

### 3. 分析错误趋势
查看"趋势图表"标签，分析：
- 错误高发时段
- 错误增长趋势
- 相关错误模式

### 4. 定位问题根源
- 查看错误堆栈定位代码位置
- 查看相关错误找出共同原因
- 检查最近的代码变更

### 5. 修复并验证
- 修复问题代码
- 本地测试验证
- 部署后持续监控

## 八、环境变量配置

### 日志级别控制
```bash
# .env文件
LOG_LEVEL=info  # error, warn, info, debug
```

### 错误收集配置
```bash
# 错误保留天数
ERROR_RETENTION_DAYS=30

# 是否启用错误收集
ENABLE_ERROR_TRACKING=true

# 错误通知邮箱（可选）
ERROR_NOTIFICATION_EMAIL=admin@example.com
```

## 九、常见问题

### Q: 错误日志太多怎么办？
A: 可以通过以下方式管理：
1. 定期清理已解决的错误
2. 调整日志级别减少记录
3. 使用批量操作忽略已知问题

### Q: 如何查看历史错误？
A:
1. Web界面支持时间范围筛选
2. 数据库中保留30天历史记录
3. 可导出错误报告存档

### Q: 错误没有记录到？
A: 检查：
1. 日志级别设置是否正确
2. 错误处理包装器是否正确使用
3. 数据库连接是否正常

### Q: 如何设置错误告警？
A: 目前需要手动配置：
1. 可以集成第三方监控服务
2. 设置定时任务检查严重错误
3. 配置邮件通知（需要额外开发）

## 十、相关文件路径

- **错误监控页面**: `/app/routes/app.errors.jsx`
- **错误API路由**: `/app/routes/api.errors.jsx`
- **错误收集服务**: `/app/services/error-collector.server.js`
- **错误分析服务**: `/app/services/error-analyzer.server.js`
- **错误处理工具**: `/app/utils/error-handler.server.js`
- **日志工具**: `/app/utils/logger.server.js`
- **翻译日志API**: `/app/routes/api.translation-logs.jsx`

---

更新时间：2024年
版本：v1.0