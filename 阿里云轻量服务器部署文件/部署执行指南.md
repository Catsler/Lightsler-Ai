# 🚀 阿里云轻量服务器部署执行指南

## 📋 部署前检查清单

在执行部署前，请确认以下事项：

- [ ] 已完成所有本地代码提交到 git
- [ ] 已准备好 SSH 密钥：`/Users/elie/Downloads/shopify.pem`
- [ ] 可以正常连接到服务器：`ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128`
- [ ] 已通知团队即将进行部署
- [ ] 选择低峰时段执行（建议凌晨或周末）

## 🎯 快速部署（推荐）

### 方法一：一键自动部署

```bash
# 进入部署文件目录
cd /Users/elie/Downloads/translate/Lightsler-Ai/阿里云轻量服务器部署文件

# 执行自动部署脚本
./deploy-to-aliyun.sh
```

**脚本会自动完成**：
1. ✅ 检查服务器连接
2. ✅ 停止 PM2 进程
3. ✅ 备份数据库（使用 sqlite3 .backup）
4. ✅ 同步代码（rsync 二阶段确认）
5. ✅ 更新配置文件
6. ✅ 安装依赖
7. ✅ 运行数据库迁移
8. ✅ 启动应用
9. ✅ 健康检查

**预计耗时**: 约 15-20 分钟

---

## 🔧 手动部署（高级）

如果需要更精细的控制，可以手动执行每个步骤：

### Step 1: SSH 连接服务器

```bash
ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128
```

### Step 2: 停止应用

```bash
pm2 stop shop1-fynony shop2-onewind
pm2 list  # 确认已停止
```

### Step 3: 备份数据库

```bash
# 创建备份目录
mkdir -p /var/www/backups

# 备份 Shop1
sqlite3 /var/www/app1-fynony/prisma/dev.sqlite \
  ".backup /var/www/backups/shop1-$(date +%Y%m%d_%H%M%S).db"

# 备份 Shop2
sqlite3 /var/www/app2-onewind/prisma/dev.sqlite \
  ".backup /var/www/backups/shop2-$(date +%Y%m%d_%H%M%S).db"

# 备份配置
cp /var/www/app1-fynony/.env /var/www/backups/shop1-$(date +%Y%m%d_%H%M%S).env
cp /var/www/app2-onewind/.env /var/www/backups/shop2-$(date +%Y%m%d_%H%M%S).env

# 查看备份
ls -lh /var/www/backups/
```

### Step 4: 同步代码（在本地执行）

```bash
# 回到本地终端
cd /Users/elie/Downloads/translate/Lightsler-Ai

# 预览同步变更
rsync -avn --delete \
  --exclude='.env' --exclude='.env.*' \
  --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  --exclude='logs/' --exclude='node_modules/' --exclude='.git/' \
  --exclude='阿里云轻量服务器部署文件/' \
  -e "ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem" \
  ./ root@47.79.77.128:/var/www/lightsler-base/

# 确认无误后，实际同步
rsync -av --delete \
  --exclude='.env' --exclude='.env.*' \
  --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  --exclude='logs/' --exclude='node_modules/' --exclude='.git/' \
  --exclude='阿里云轻量服务器部署文件/' \
  -e "ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem" \
  ./ root@47.79.77.128:/var/www/lightsler-base/
```

### Step 5: 分发代码到各店铺（在服务器执行）

```bash
# 分发到 Shop1
rsync -av --delete \
  --exclude='.env' --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  /var/www/lightsler-base/ /var/www/app1-fynony/

# 分发到 Shop2
rsync -av --delete \
  --exclude='.env' --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  /var/www/lightsler-base/ /var/www/app2-onewind/
```

### Step 6: 更新配置文件（在本地执行）

```bash
cd /Users/elie/Downloads/translate/Lightsler-Ai/阿里云轻量服务器部署文件

# 上传合并脚本和模板
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  merge-env.sh root@47.79.77.128:/tmp/
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  ../. env.example root@47.79.77.128:/tmp/

# 上传 Shopify 配置
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  shop1-shopify.app.toml root@47.79.77.128:/var/www/app1-fynony/shopify.app.toml
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  shop2-shopify.app.toml root@47.79.77.128:/var/www/app2-onewind/shopify.app.toml

# 上传 PM2 配置
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  ecosystem.config.js root@47.79.77.128:/var/www/ecosystem-simple.config.js
```

### Step 7: 合并环境变量（在服务器执行）

```bash
# 添加执行权限
chmod +x /tmp/merge-env.sh

# 合并 Shop1
/tmp/merge-env.sh /var/www/app1-fynony/.env /tmp/.env.example

# 合并 Shop2
/tmp/merge-env.sh /var/www/app2-onewind/.env /tmp/.env.example

# 检查环境变量
grep -E 'API_MONITORING|LOGGING' /var/www/app1-fynony/.env
```

### Step 8: 安装依赖

```bash
# Shop1
cd /var/www/app1-fynony
npm install --production

# Shop2
cd /var/www/app2-onewind
npm install --production
```

### Step 9: 数据库迁移

```bash
# Shop1
cd /var/www/app1-fynony
npx prisma generate
npx prisma migrate deploy

# Shop2
cd /var/www/app2-onewind
npx prisma generate
npx prisma migrate deploy
```

### Step 10: 启动应用

```bash
pm2 start shop1-fynony shop2-onewind
pm2 save
pm2 list
```

### Step 11: 健康检查

```bash
# 等待30秒让应用启动
sleep 30

# 检查 Shop1
curl http://localhost:3001/healthz

# 检查 Shop2
curl http://localhost:3002/healthz

# 查看日志
pm2 logs --lines 20
```

---

## 🔐 Shopify 权限部署

代码部署完成后，需要更新 Shopify 应用权限：

### Shop1 部署

```bash
cd /var/www/app1-fynony

# 预览配置变更
shopify app config compare

# 部署到 Shopify
shopify app deploy
```

**认证步骤**：
1. 记录显示的验证码（如：`VNJD-ZNFD`）
2. 在浏览器打开：`https://accounts.shopify.com/activate-with-code?device_code%5Buser_code%5D=<验证码>`
3. 登录 Shopify Partner 账号
4. 输入验证码完成认证
5. 返回终端按 `y` 确认部署

### Shop2 部署

```bash
cd /var/www/app2-onewind
shopify app deploy
# 重复上述认证步骤
```

---

## ✅ 部署验证

### 1. 检查 PM2 状态

```bash
pm2 list
pm2 monit
```

**预期结果**：
- shop1-fynony: online
- shop2-onewind: online
- 重启次数: 0
- 内存使用: < 1.5GB

### 2. 检查端口监听

```bash
netstat -tlnp | grep -E '3001|3002'
```

**预期结果**：
```
tcp  0  0.0.0.0:3001  *  LISTEN  pid/node
tcp  0  0.0.0.0:3002  *  LISTEN  pid/node
```

### 3. 测试 API 端点

```bash
# Shop1
curl http://localhost:3001/api/health
curl http://localhost:3001/healthz | jq '.'

# Shop2
curl http://localhost:3002/api/health
curl http://localhost:3002/healthz | jq '.'
```

### 4. 验证外部访问

在浏览器访问：
- https://fynony.ease-joy.fun
- https://onewind.ease-joy.fun

### 5. 测试核心功能

登录 Shopify Admin，测试：
- ✅ 应用可以打开
- ✅ 扫描资源功能
- ✅ 翻译功能
- ✅ 语言覆盖率查询

### 6. 检查日志

```bash
# 实时日志
pm2 logs

# 错误日志
pm2 logs shop1-fynony --err
pm2 logs shop2-onewind --err

# 最近50行
pm2 logs --lines 50 --nostream
```

---

## 🚨 故障排查

### 问题1：应用无法启动

```bash
# 查看详细日志
pm2 logs shop1-fynony --lines 100

# 检查端口占用
lsof -i:3001

# 检查环境变量
cd /var/www/app1-fynony
cat .env | grep -E 'PORT|SHOPIFY_API_KEY'

# 手动启动测试
cd /var/www/app1-fynony
npm start
```

### 问题2：数据库错误

```bash
# 检查数据库文件
ls -lh /var/www/app1-fynony/prisma/dev.sqlite

# 检查迁移状态
cd /var/www/app1-fynony
npx prisma migrate status

# 重新生成 Prisma Client
npx prisma generate
```

### 问题3：认证循环

```bash
# 检查 Shopify 配置
cat /var/www/app1-fynony/shopify.app.toml | grep -E 'client_id|application_url'

# 重新部署到 Shopify
cd /var/www/app1-fynony
shopify app deploy
```

### 问题4：内存溢出

```bash
# 增加内存限制
pm2 stop shop1-fynony
pm2 start shop1-fynony --max-memory-restart 2G
pm2 save

# 清理日志
pm2 flush
```

---

## 🔄 回滚方案

如果部署失败，可以快速回滚：

```bash
# 1. 停止新版本
pm2 stop shop1-fynony shop2-onewind

# 2. 恢复数据库（找到最近的备份）
ls -lht /var/www/backups/ | head -10

cp /var/www/backups/shop1-TIMESTAMP.db /var/www/app1-fynony/prisma/dev.sqlite
cp /var/www/backups/shop2-TIMESTAMP.db /var/www/app2-onewind/prisma/dev.sqlite

# 3. 恢复配置
cp /var/www/backups/shop1-TIMESTAMP.env /var/www/app1-fynony/.env
cp /var/www/backups/shop2-TIMESTAMP.env /var/www/app2-onewind/.env

# 4. 重启应用
pm2 start shop1-fynony shop2-onewind

# 5. 验证
pm2 logs --lines 20
```

---

## 📊 监控和维护

### 日常监控

```bash
# 每天检查
pm2 status
pm2 monit

# 每周检查
df -h /var/www
du -sh /var/www/app1-fynony/prisma/dev.sqlite
du -sh /var/www/app2-onewind/prisma/dev.sqlite

# 清理旧备份（保留最近30天）
find /var/www/backups/ -name "*.db" -mtime +30 -delete
```

### 自动化监控（可选）

添加到 crontab：

```bash
# 每5分钟检查健康状态
*/5 * * * * /var/www/lightsler-base/阿里云轻量服务器部署文件/health-check.sh >> /var/log/health-check.log 2>&1

# 每天凌晨2点备份数据库
0 2 * * * sqlite3 /var/www/app1-fynony/prisma/dev.sqlite ".backup /var/www/backups/daily-shop1-$(date +\%Y\%m\%d).db"
0 2 * * * sqlite3 /var/www/app2-onewind/prisma/dev.sqlite ".backup /var/www/backups/daily-shop2-$(date +\%Y\%m\%d).db"

# 每周日清理30天前的备份
0 3 * * 0 find /var/www/backups/ -mtime +30 -delete
```

---

## 📞 技术支持

**部署脚本位置**：
- `/Users/elie/Downloads/translate/Lightsler-Ai/阿里云轻量服务器部署文件/`

**关键文件**：
- `deploy-to-aliyun.sh` - 自动部署脚本
- `merge-env.sh` - 环境变量合并
- `health-check.sh` - 健康检查
- `shop1-shopify.app.toml` - Shop1 配置
- `shop2-shopify.app.toml` - Shop2 配置
- `ecosystem.config.js` - PM2 配置

**服务器信息**：
- IP: 47.79.77.128
- SSH Key: /Users/elie/Downloads/shopify.pem
- Bind IP: 192.168.31.152

**应用信息**：
- Shop1: https://fynony.ease-joy.fun (端口3001)
- Shop2: https://onewind.ease-joy.fun (端口3002)

---

## 🎓 最佳实践

1. **部署前**：
   - 选择低峰时段
   - 提前通知团队
   - 确认代码已测试

2. **部署中**：
   - 仔细阅读每个步骤的输出
   - 遇到错误立即停止
   - 保留所有备份

3. **部署后**：
   - 完整测试所有核心功能
   - 观察日志15分钟
   - 监控性能指标24小时

4. **安全建议**：
   - 定期更新 SSH 密钥
   - 定期备份数据库
   - 定期检查日志
   - 及时更新依赖包

---

*最后更新: 2025-09-30*