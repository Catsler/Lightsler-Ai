# ğŸš€ é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ‰§è¡ŒæŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

åœ¨æ‰§è¡Œéƒ¨ç½²å‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] å·²å®Œæˆæ‰€æœ‰æœ¬åœ°ä»£ç æäº¤åˆ° git
- [ ] å·²å‡†å¤‡å¥½ SSH å¯†é’¥ï¼š`/Users/elie/Downloads/shopify.pem`
- [ ] å¯ä»¥æ­£å¸¸è¿æ¥åˆ°æœåŠ¡å™¨ï¼š`ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128`
- [ ] å·²é€šçŸ¥å›¢é˜Ÿå³å°†è¿›è¡Œéƒ¨ç½²
- [ ] é€‰æ‹©ä½å³°æ—¶æ®µæ‰§è¡Œï¼ˆå»ºè®®å‡Œæ™¨æˆ–å‘¨æœ«ï¼‰

## ğŸ¯ å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

### æ–¹æ³•ä¸€ï¼šä¸€é”®è‡ªåŠ¨éƒ¨ç½²

```bash
# è¿›å…¥éƒ¨ç½²æ–‡ä»¶ç›®å½•
cd /Users/elie/Downloads/translate/Lightsler-Ai/é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶

# æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²è„šæœ¬
./deploy-to-aliyun.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
1. âœ… æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
2. âœ… åœæ­¢ PM2 è¿›ç¨‹
3. âœ… å¤‡ä»½æ•°æ®åº“ï¼ˆä½¿ç”¨ sqlite3 .backupï¼‰
4. âœ… åŒæ­¥ä»£ç ï¼ˆrsync äºŒé˜¶æ®µç¡®è®¤ï¼‰
5. âœ… æ›´æ–°é…ç½®æ–‡ä»¶
6. âœ… å®‰è£…ä¾èµ–
7. âœ… è¿è¡Œæ•°æ®åº“è¿ç§»
8. âœ… å¯åŠ¨åº”ç”¨
9. âœ… å¥åº·æ£€æŸ¥

**é¢„è®¡è€—æ—¶**: çº¦ 15-20 åˆ†é’Ÿ

---

## ğŸ”§ æ‰‹åŠ¨éƒ¨ç½²ï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼š

### Step 1: SSH è¿æ¥æœåŠ¡å™¨

```bash
ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128
```

### Step 2: åœæ­¢åº”ç”¨

```bash
pm2 stop shop1-fynony shop2-onewind
pm2 list  # ç¡®è®¤å·²åœæ­¢
```

### Step 3: å¤‡ä»½æ•°æ®åº“

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /var/www/backups

# å¤‡ä»½ Shop1
sqlite3 /var/www/app1-fynony/prisma/dev.sqlite \
  ".backup /var/www/backups/shop1-$(date +%Y%m%d_%H%M%S).db"

# å¤‡ä»½ Shop2
sqlite3 /var/www/app2-onewind/prisma/dev.sqlite \
  ".backup /var/www/backups/shop2-$(date +%Y%m%d_%H%M%S).db"

# å¤‡ä»½é…ç½®
cp /var/www/app1-fynony/.env /var/www/backups/shop1-$(date +%Y%m%d_%H%M%S).env
cp /var/www/app2-onewind/.env /var/www/backups/shop2-$(date +%Y%m%d_%H%M%S).env

# æŸ¥çœ‹å¤‡ä»½
ls -lh /var/www/backups/
```

### Step 4: åŒæ­¥ä»£ç ï¼ˆåœ¨æœ¬åœ°æ‰§è¡Œï¼‰

```bash
# å›åˆ°æœ¬åœ°ç»ˆç«¯
cd /Users/elie/Downloads/translate/Lightsler-Ai

# é¢„è§ˆåŒæ­¥å˜æ›´
rsync -avn --delete \
  --exclude='.env' --exclude='.env.*' \
  --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  --exclude='logs/' --exclude='node_modules/' --exclude='.git/' \
  --exclude='é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶/' \
  -e "ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem" \
  ./ root@47.79.77.128:/var/www/lightsler-base/

# ç¡®è®¤æ— è¯¯åï¼Œå®é™…åŒæ­¥
rsync -av --delete \
  --exclude='.env' --exclude='.env.*' \
  --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  --exclude='logs/' --exclude='node_modules/' --exclude='.git/' \
  --exclude='é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶/' \
  -e "ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem" \
  ./ root@47.79.77.128:/var/www/lightsler-base/
```

### Step 5: åˆ†å‘ä»£ç åˆ°å„åº—é“ºï¼ˆåœ¨æœåŠ¡å™¨æ‰§è¡Œï¼‰

```bash
# åˆ†å‘åˆ° Shop1
rsync -av --delete \
  --exclude='.env' --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  /var/www/lightsler-base/ /var/www/app1-fynony/

# åˆ†å‘åˆ° Shop2
rsync -av --delete \
  --exclude='.env' --exclude='shopify.app.toml' --exclude='prisma/*.db*' \
  /var/www/lightsler-base/ /var/www/app2-onewind/
```

### Step 6: æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆåœ¨æœ¬åœ°æ‰§è¡Œï¼‰

```bash
cd /Users/elie/Downloads/translate/Lightsler-Ai/é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶

# ä¸Šä¼ åˆå¹¶è„šæœ¬å’Œæ¨¡æ¿
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  merge-env.sh root@47.79.77.128:/tmp/
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  ../. env.example root@47.79.77.128:/tmp/

# ä¸Šä¼  Shopify é…ç½®
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  shop1-shopify.app.toml root@47.79.77.128:/var/www/app1-fynony/shopify.app.toml
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  shop2-shopify.app.toml root@47.79.77.128:/var/www/app2-onewind/shopify.app.toml

# ä¸Šä¼  PM2 é…ç½®
scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem \
  ecosystem.config.js root@47.79.77.128:/var/www/ecosystem-simple.config.js
```

### Step 7: åˆå¹¶ç¯å¢ƒå˜é‡ï¼ˆåœ¨æœåŠ¡å™¨æ‰§è¡Œï¼‰

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /tmp/merge-env.sh

# åˆå¹¶ Shop1
/tmp/merge-env.sh /var/www/app1-fynony/.env /tmp/.env.example

# åˆå¹¶ Shop2
/tmp/merge-env.sh /var/www/app2-onewind/.env /tmp/.env.example

# æ£€æŸ¥ç¯å¢ƒå˜é‡
grep -E 'API_MONITORING|LOGGING' /var/www/app1-fynony/.env
```

### Step 8: å®‰è£…ä¾èµ–

```bash
# Shop1
cd /var/www/app1-fynony
npm install --production

# Shop2
cd /var/www/app2-onewind
npm install --production
```

### Step 9: æ•°æ®åº“è¿ç§»

```bash
# Shop1
cd /var/www/app1-fynony
npx prisma generate
npx prisma migrate deploy

# Shop2
cd /var/www/app2-onewind
npx prisma generate
npx prisma migrate deploy
```

### Step 10: å¯åŠ¨åº”ç”¨

```bash
pm2 start shop1-fynony shop2-onewind
pm2 save
pm2 list
```

### Step 11: å¥åº·æ£€æŸ¥

```bash
# ç­‰å¾…30ç§’è®©åº”ç”¨å¯åŠ¨
sleep 30

# æ£€æŸ¥ Shop1
curl http://localhost:3001/healthz

# æ£€æŸ¥ Shop2
curl http://localhost:3002/healthz

# æŸ¥çœ‹æ—¥å¿—
pm2 logs --lines 20
```

---

## ğŸ” Shopify æƒé™éƒ¨ç½²

ä»£ç éƒ¨ç½²å®Œæˆåï¼Œéœ€è¦æ›´æ–° Shopify åº”ç”¨æƒé™ï¼š

### Shop1 éƒ¨ç½²

```bash
cd /var/www/app1-fynony

# é¢„è§ˆé…ç½®å˜æ›´
shopify app config compare

# éƒ¨ç½²åˆ° Shopify
shopify app deploy
```

**è®¤è¯æ­¥éª¤**ï¼š
1. è®°å½•æ˜¾ç¤ºçš„éªŒè¯ç ï¼ˆå¦‚ï¼š`VNJD-ZNFD`ï¼‰
2. åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š`https://accounts.shopify.com/activate-with-code?device_code%5Buser_code%5D=<éªŒè¯ç >`
3. ç™»å½• Shopify Partner è´¦å·
4. è¾“å…¥éªŒè¯ç å®Œæˆè®¤è¯
5. è¿”å›ç»ˆç«¯æŒ‰ `y` ç¡®è®¤éƒ¨ç½²

### Shop2 éƒ¨ç½²

```bash
cd /var/www/app2-onewind
shopify app deploy
# é‡å¤ä¸Šè¿°è®¤è¯æ­¥éª¤
```

---

## âœ… éƒ¨ç½²éªŒè¯

### 1. æ£€æŸ¥ PM2 çŠ¶æ€

```bash
pm2 list
pm2 monit
```

**é¢„æœŸç»“æœ**ï¼š
- shop1-fynony: online
- shop2-onewind: online
- é‡å¯æ¬¡æ•°: 0
- å†…å­˜ä½¿ç”¨: < 1.5GB

### 2. æ£€æŸ¥ç«¯å£ç›‘å¬

```bash
netstat -tlnp | grep -E '3001|3002'
```

**é¢„æœŸç»“æœ**ï¼š
```
tcp  0  0.0.0.0:3001  *  LISTEN  pid/node
tcp  0  0.0.0.0:3002  *  LISTEN  pid/node
```

### 3. æµ‹è¯• API ç«¯ç‚¹

```bash
# Shop1
curl http://localhost:3001/api/health
curl http://localhost:3001/healthz | jq '.'

# Shop2
curl http://localhost:3002/api/health
curl http://localhost:3002/healthz | jq '.'
```

### 4. éªŒè¯å¤–éƒ¨è®¿é—®

åœ¨æµè§ˆå™¨è®¿é—®ï¼š
- https://fynony.ease-joy.fun
- https://onewind.ease-joy.fun

### 5. æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½

ç™»å½• Shopify Adminï¼Œæµ‹è¯•ï¼š
- âœ… åº”ç”¨å¯ä»¥æ‰“å¼€
- âœ… æ‰«æèµ„æºåŠŸèƒ½
- âœ… ç¿»è¯‘åŠŸèƒ½
- âœ… è¯­è¨€è¦†ç›–ç‡æŸ¥è¯¢

### 6. æ£€æŸ¥æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
pm2 logs

# é”™è¯¯æ—¥å¿—
pm2 logs shop1-fynony --err
pm2 logs shop2-onewind --err

# æœ€è¿‘50è¡Œ
pm2 logs --lines 50 --nostream
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šåº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs shop1-fynony --lines 100

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i:3001

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cd /var/www/app1-fynony
cat .env | grep -E 'PORT|SHOPIFY_API_KEY'

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /var/www/app1-fynony
npm start
```

### é—®é¢˜2ï¼šæ•°æ®åº“é”™è¯¯

```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -lh /var/www/app1-fynony/prisma/dev.sqlite

# æ£€æŸ¥è¿ç§»çŠ¶æ€
cd /var/www/app1-fynony
npx prisma migrate status

# é‡æ–°ç”Ÿæˆ Prisma Client
npx prisma generate
```

### é—®é¢˜3ï¼šè®¤è¯å¾ªç¯

```bash
# æ£€æŸ¥ Shopify é…ç½®
cat /var/www/app1-fynony/shopify.app.toml | grep -E 'client_id|application_url'

# é‡æ–°éƒ¨ç½²åˆ° Shopify
cd /var/www/app1-fynony
shopify app deploy
```

### é—®é¢˜4ï¼šå†…å­˜æº¢å‡º

```bash
# å¢åŠ å†…å­˜é™åˆ¶
pm2 stop shop1-fynony
pm2 start shop1-fynony --max-memory-restart 2G
pm2 save

# æ¸…ç†æ—¥å¿—
pm2 flush
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# 1. åœæ­¢æ–°ç‰ˆæœ¬
pm2 stop shop1-fynony shop2-onewind

# 2. æ¢å¤æ•°æ®åº“ï¼ˆæ‰¾åˆ°æœ€è¿‘çš„å¤‡ä»½ï¼‰
ls -lht /var/www/backups/ | head -10

cp /var/www/backups/shop1-TIMESTAMP.db /var/www/app1-fynony/prisma/dev.sqlite
cp /var/www/backups/shop2-TIMESTAMP.db /var/www/app2-onewind/prisma/dev.sqlite

# 3. æ¢å¤é…ç½®
cp /var/www/backups/shop1-TIMESTAMP.env /var/www/app1-fynony/.env
cp /var/www/backups/shop2-TIMESTAMP.env /var/www/app2-onewind/.env

# 4. é‡å¯åº”ç”¨
pm2 start shop1-fynony shop2-onewind

# 5. éªŒè¯
pm2 logs --lines 20
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¸¸ç›‘æ§

```bash
# æ¯å¤©æ£€æŸ¥
pm2 status
pm2 monit

# æ¯å‘¨æ£€æŸ¥
df -h /var/www
du -sh /var/www/app1-fynony/prisma/dev.sqlite
du -sh /var/www/app2-onewind/prisma/dev.sqlite

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find /var/www/backups/ -name "*.db" -mtime +30 -delete
```

### è‡ªåŠ¨åŒ–ç›‘æ§ï¼ˆå¯é€‰ï¼‰

æ·»åŠ åˆ° crontabï¼š

```bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥å¥åº·çŠ¶æ€
*/5 * * * * /var/www/lightsler-base/é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶/health-check.sh >> /var/log/health-check.log 2>&1

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®åº“
0 2 * * * sqlite3 /var/www/app1-fynony/prisma/dev.sqlite ".backup /var/www/backups/daily-shop1-$(date +\%Y\%m\%d).db"
0 2 * * * sqlite3 /var/www/app2-onewind/prisma/dev.sqlite ".backup /var/www/backups/daily-shop2-$(date +\%Y\%m\%d).db"

# æ¯å‘¨æ—¥æ¸…ç†30å¤©å‰çš„å¤‡ä»½
0 3 * * 0 find /var/www/backups/ -mtime +30 -delete
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**éƒ¨ç½²è„šæœ¬ä½ç½®**ï¼š
- `/Users/elie/Downloads/translate/Lightsler-Ai/é˜¿é‡Œäº‘è½»é‡æœåŠ¡å™¨éƒ¨ç½²æ–‡ä»¶/`

**å…³é”®æ–‡ä»¶**ï¼š
- `deploy-to-aliyun.sh` - è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
- `merge-env.sh` - ç¯å¢ƒå˜é‡åˆå¹¶
- `health-check.sh` - å¥åº·æ£€æŸ¥
- `shop1-shopify.app.toml` - Shop1 é…ç½®
- `shop2-shopify.app.toml` - Shop2 é…ç½®
- `ecosystem.config.js` - PM2 é…ç½®

**æœåŠ¡å™¨ä¿¡æ¯**ï¼š
- IP: 47.79.77.128
- SSH Key: /Users/elie/Downloads/shopify.pem
- Bind IP: 192.168.31.152

**åº”ç”¨ä¿¡æ¯**ï¼š
- Shop1: https://fynony.ease-joy.fun (ç«¯å£3001)
- Shop2: https://onewind.ease-joy.fun (ç«¯å£3002)

---

## ğŸ“ æœ€ä½³å®è·µ

1. **éƒ¨ç½²å‰**ï¼š
   - é€‰æ‹©ä½å³°æ—¶æ®µ
   - æå‰é€šçŸ¥å›¢é˜Ÿ
   - ç¡®è®¤ä»£ç å·²æµ‹è¯•

2. **éƒ¨ç½²ä¸­**ï¼š
   - ä»”ç»†é˜…è¯»æ¯ä¸ªæ­¥éª¤çš„è¾“å‡º
   - é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢
   - ä¿ç•™æ‰€æœ‰å¤‡ä»½

3. **éƒ¨ç½²å**ï¼š
   - å®Œæ•´æµ‹è¯•æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
   - è§‚å¯Ÿæ—¥å¿—15åˆ†é’Ÿ
   - ç›‘æ§æ€§èƒ½æŒ‡æ ‡24å°æ—¶

4. **å®‰å…¨å»ºè®®**ï¼š
   - å®šæœŸæ›´æ–° SSH å¯†é’¥
   - å®šæœŸå¤‡ä»½æ•°æ®åº“
   - å®šæœŸæ£€æŸ¥æ—¥å¿—
   - åŠæ—¶æ›´æ–°ä¾èµ–åŒ…

---

*æœ€åæ›´æ–°: 2025-09-30*