# 📚 轻量服务器稳定操作说明

> 本文档详细记录了Shopify多语言翻译应用在轻量云服务器上的部署和运维操作流程。

## 📋 目录

1. [服务器基础信息](#1-服务器基础信息)
2. [多租户架构说明](#2-多租户架构说明)
3. [日常操作流程](#3-日常操作流程)
4. [监控和维护](#4-监控和维护)
5. [故障排查指南](#5-故障排查指南)
6. [Shopify认证部署](#6-shopify认证部署)
7. [自动化脚本说明](#7-自动化脚本说明)
8. [最佳实践建议](#8-最佳实践建议)

---

## 1. 服务器基础信息

### 1.1 服务器连接信息
```bash
# 服务器IP
SERVER_IP: 47.79.77.128

# SSH密钥位置
SSH_KEY: /Users/elie/Downloads/shopify.pem

# 用户名
USER: root

# 绑定本地IP（绕过VPN）
BIND_IP: 192.168.31.152  # 或 192.168.28.171
```

### 1.2 SSH连接函数
```bash
# 基础SSH连接（绕过VPN）
ssh_cmd() {
    ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128 "$@"
}

# SCP文件传输（绕过VPN）
scp_cmd() {
    scp -o BindAddress=192.168.31.152 -i /Users/elie/Downloads/shopify.pem "$@"
}
```

### 1.3 服务器目录结构
```
/var/www/
├── app1-fynony/          # Shop1应用目录
│   ├── build/            # 构建文件
│   ├── prisma/           # 数据库文件
│   │   └── prod.db       # SQLite数据库
│   ├── node_modules/     # 依赖包
│   ├── .env              # 环境变量
│   └── shopify.app.toml  # Shopify配置
│
├── app2-onewind/         # Shop2应用目录
│   └── (同上结构)
│
├── lightsler-base/       # 基础代码目录
└── ecosystem-simple.config.js  # PM2配置文件
```

---

## 2. 多租户架构说明

### 2.1 Shop1 - Fynony配置
```yaml
域名: https://fynony.ease-joy.fun
端口: 3001
商店: fynony.myshopify.com
Client ID: f97170933cde079c914f7df7e90cd806
数据库: /var/www/app1-fynony/prisma/prod.db
PM2进程名: shop1-fynony
```

### 2.2 Shop2 - OneWind配置
```yaml
域名: https://onewind.ease-joy.fun
端口: 3002
商店: onewindoutdoors.myshopify.com
Client ID: 69e94e0e69e085a95e3cc1e37e37f3ea
数据库: /var/www/app2-onewind/prisma/prod.db
PM2进程名: shop2-onewind
```

### 2.3 Cloudflare隧道配置
```yaml
隧道服务: cloudflared
域名映射:
  - fynony.ease-joy.fun → localhost:3001
  - onewind.ease-joy.fun → localhost:3002
```

---

## 3. 日常操作流程

### 3.1 部署新代码

#### 完整部署流程
```bash
# 1. 停止现有进程
ssh_cmd "pm2 delete all"

# 2. 更新代码库（假设已更新lightsler-base）
ssh_cmd "cp -r /var/www/lightsler-base/* /var/www/app1-fynony/"
ssh_cmd "cp -r /var/www/lightsler-base/* /var/www/app2-onewind/"

# 3. 更新配置文件
scp_cmd /path/to/shop1/.env root@47.79.77.128:/var/www/app1-fynony/.env
scp_cmd /path/to/shop2/.env root@47.79.77.128:/var/www/app2-onewind/.env

# 4. 安装依赖（如需要）
ssh_cmd "cd /var/www/app1-fynony && npm install"
ssh_cmd "cd /var/www/app2-onewind && npm install"

# 5. 运行数据库迁移
ssh_cmd "cd /var/www/app1-fynony && npx prisma migrate deploy"
ssh_cmd "cd /var/www/app2-onewind && npx prisma migrate deploy"

# 6. 启动应用
ssh_cmd "pm2 start /var/www/ecosystem-simple.config.js"
ssh_cmd "pm2 save"
```

### 3.2 快速重启应用
```bash
# 重启所有应用
ssh_cmd "pm2 restart all"

# 重启单个应用
ssh_cmd "pm2 restart shop1-fynony"
ssh_cmd "pm2 restart shop2-onewind"

# 重载应用（零停机时间）
ssh_cmd "pm2 reload all"
```

### 3.3 更新配置文件
```bash
# 1. 上传新的配置文件
scp_cmd shop1-fynony/.env root@47.79.77.128:/var/www/app1-fynony/.env
scp_cmd shop1-fynony/shopify.app.toml root@47.79.77.128:/var/www/app1-fynony/shopify.app.toml

# 2. 重启应用使配置生效
ssh_cmd "pm2 restart shop1-fynony"
```

---

## 4. 监控和维护

### 4.1 查看应用状态
```bash
# PM2进程状态
ssh_cmd "pm2 status"

# 详细状态信息
ssh_cmd "pm2 list"

# 查看单个应用详情
ssh_cmd "pm2 describe shop1-fynony"
```

### 4.2 日志查看
```bash
# 实时查看所有日志
ssh_cmd "pm2 logs"

# 查看指定应用日志（最近20行）
ssh_cmd "pm2 logs shop1-fynony --lines 20 --nostream"
ssh_cmd "pm2 logs shop2-onewind --lines 20 --nostream"

# 查看错误日志
ssh_cmd "tail -n 50 /var/www/app1-fynony/error.log"
ssh_cmd "tail -n 50 /var/www/app2-onewind/error.log"

# 实时跟踪日志
ssh_cmd "pm2 logs shop1-fynony --lines 0"
```

### 4.3 资源监控
```bash
# PM2监控面板
ssh_cmd "pm2 monit"

# 内存使用情况
ssh_cmd "pm2 list | grep -E 'shop|memory'"

# 系统资源
ssh_cmd "free -h"
ssh_cmd "df -h /var/www"
ssh_cmd "top -n 1 | head -20"

# CPU使用率
ssh_cmd "pm2 status | grep -E 'CPU|Memory'"
```

### 4.4 数据库管理
```bash
# 查看数据库大小
ssh_cmd "ls -lh /var/www/app1-fynony/prisma/prod.db"
ssh_cmd "ls -lh /var/www/app2-onewind/prisma/prod.db"

# 备份数据库
ssh_cmd "cp /var/www/app1-fynony/prisma/prod.db /var/www/app1-fynony/prisma/prod.db.backup"
ssh_cmd "cp /var/www/app2-onewind/prisma/prod.db /var/www/app2-onewind/prisma/prod.db.backup"

# 执行数据库迁移
ssh_cmd "cd /var/www/app1-fynony && npx prisma migrate deploy"
```

### 4.5 端口监听检查
```bash
# 检查应用端口
ssh_cmd "netstat -tlnp | grep -E '3001|3002'"

# 检查Cloudflare隧道
ssh_cmd "systemctl status cloudflared"
```

---

## 5. 故障排查指南

### 5.1 应用无法启动

#### 检查步骤
```bash
# 1. 查看PM2错误日志
ssh_cmd "pm2 logs shop1-fynony --err --lines 50"

# 2. 检查端口占用
ssh_cmd "lsof -i:3001"
ssh_cmd "lsof -i:3002"

# 3. 检查环境变量
ssh_cmd "cat /var/www/app1-fynony/.env | grep -E 'PORT|APP_URL'"

# 4. 验证数据库连接
ssh_cmd "cd /var/www/app1-fynony && npx prisma db push --accept-data-loss"
```

### 5.2 认证循环问题

#### 解决方案
```bash
# 1. 检查应用URL配置
ssh_cmd "grep application_url /var/www/app1-fynony/shopify.app.toml"

# 2. 验证回调URL
ssh_cmd "grep redirect_urls /var/www/app1-fynony/shopify.app.toml"

# 3. 重新部署到Shopify
ssh_cmd "cd /var/www/app1-fynony && shopify app deploy"
```

### 5.3 内存溢出

#### 处理方法
```bash
# 1. 增加内存限制
ssh_cmd "pm2 delete shop1-fynony"
ssh_cmd "pm2 start npm --name shop1-fynony -- start --max-memory-restart 2G"

# 2. 清理日志文件
ssh_cmd "pm2 flush"

# 3. 重启应用
ssh_cmd "pm2 restart all"
```

### 5.4 数据库锁定

#### 解决步骤
```bash
# 1. 停止应用
ssh_cmd "pm2 stop shop1-fynony"

# 2. 删除WAL文件
ssh_cmd "rm -f /var/www/app1-fynony/prisma/prod.db-wal"
ssh_cmd "rm -f /var/www/app1-fynony/prisma/prod.db-shm"

# 3. 重启应用
ssh_cmd "pm2 start shop1-fynony"
```

---

## 6. Shopify认证部署

### 6.1 部署到Shopify后台

#### 完整认证流程
```bash
# 1. SSH登录服务器
ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128

# 2. 进入应用目录
cd /var/www/app1-fynony

# 3. 执行部署命令
shopify app deploy
```

#### 认证步骤
1. 记录显示的验证码（如：`VNJD-ZNFD`）
2. 在浏览器打开认证URL：
   ```
   https://accounts.shopify.com/activate-with-code?device_code%5Buser_code%5D=验证码
   ```
3. 登录Shopify Partner账号
4. 输入验证码完成认证
5. 返回终端按`y`确认部署

### 6.2 验证部署成功
```bash
# 检查Update URLs状态
ssh_cmd "cd /var/www/app1-fynony && shopify app info | grep 'Update URLs'"

# 应显示: Update URLs  Yes
```

---

## 7. 自动化脚本说明

### 7.1 deploy-simple.sh
**用途**: 完整部署多租户应用
```bash
./deploy-simple.sh
```
- 停止现有进程
- 创建应用目录
- 复制代码和配置
- 设置数据库
- 启动PM2进程

### 7.2 monitor-apps.sh
**用途**: 监控应用状态
```bash
./monitor-apps.sh
```
- 显示PM2进程状态
- 查看最近日志
- 显示内存使用
- 检查数据库状态
- 验证端口监听

### 7.3 quick-fix-deployment.sh
**用途**: 快速更新配置文件
```bash
./quick-fix-deployment.sh
```
- 上传新配置文件
- 重启PM2进程
- 查看启动日志

### 7.4 auto-deploy.sh
**用途**: 自动更新配置
```bash
./auto-deploy.sh
```
- 检查当前配置
- 重启应用

---

## 8. 最佳实践建议

### 8.1 部署前准备
- [ ] 备份当前数据库
- [ ] 检查配置文件正确性
- [ ] 确认域名解析正常
- [ ] 验证SSL证书有效

### 8.2 部署时注意
- [ ] 使用PM2 reload而非restart（零停机）
- [ ] 分步骤部署，先部署一个应用测试
- [ ] 保留旧版本代码备份
- [ ] 记录部署时间和版本

### 8.3 部署后验证
- [ ] 检查所有进程正常运行
- [ ] 验证应用可以访问
- [ ] 测试OAuth认证流程
- [ ] 检查Webhook注册状态
- [ ] 监控错误日志15分钟

### 8.4 日常维护
- 每日检查PM2状态
- 每周备份数据库
- 定期清理日志文件
- 监控磁盘空间使用
- 及时更新安全补丁

### 8.5 应急预案
1. **保持备份脚本**
   ```bash
   # 每日自动备份
   0 2 * * * /root/backup-apps.sh
   ```

2. **快速回滚方案**
   ```bash
   # 保留上个版本
   cp -r /var/www/app1-fynony /var/www/app1-fynony.backup
   ```

3. **紧急联系方式**
   - Shopify Partner Support
   - Cloudflare Support
   - 服务器运维团队

---

## 📝 常用命令速查

```bash
# 快速SSH连接
alias ssh_shop='ssh -b 192.168.31.152 -i /Users/elie/Downloads/shopify.pem root@47.79.77.128'

# 查看状态
ssh_shop "pm2 status"

# 查看日志
ssh_shop "pm2 logs --lines 20"

# 重启应用
ssh_shop "pm2 restart all"

# 监控资源
ssh_shop "pm2 monit"

# 数据库备份
ssh_shop "cp /var/www/app1-fynony/prisma/prod.db /backup/shop1-$(date +%Y%m%d).db"
```

---

## 🔒 安全建议

1. **定期更新SSH密钥**
2. **使用强密码保护数据库**
3. **限制服务器访问IP**
4. **启用防火墙规则**
5. **定期审计日志**
6. **保持软件更新**
7. **使用HTTPS加密**
8. **定期备份数据**

---

## 📞 技术支持

- **项目文档**: `/Users/elie/Downloads/translate/Lightsler-Ai/CLAUDE.md`
- **部署脚本**: `/Users/elie/Downloads/*.sh`
- **配置文件**: `/Users/elie/Downloads/shop*/`
- **问题反馈**: 创建GitHub Issue

---

*最后更新: 2025年9月21日*